<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="NormTracker" 
           Manufacturer="FK-Norm" 
           Version="1.0.0"
           UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
           Language="1033"
           Compressed="yes">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Properties - путь к Node.js (устанавливается через SetProperty из переменной сборки) -->
    <Property Id="NODEPATH" Value="C:\Program Files\nodejs\node.exe" />
    
    <Feature Id="ProductFeature" Title="NormTracker" Level="1">
      <ComponentGroupRef Id="ApplicationFiles" />
      <ComponentGroupRef Id="NSSMFiles" />
      <ComponentRef Id="EnvironmentFile" />
      <ComponentRef Id="LogsDirectory" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>
  </Package>

  <!-- Структура директорий -->
  <StandardDirectory Id="ProgramFilesFolder">
    <Directory Id="INSTALLFOLDER" Name="NormTracker" />
  </StandardDirectory>

  <StandardDirectory Id="ProgramMenuFolder">
    <Directory Id="ApplicationProgramsFolder" Name="NormTracker" />
  </StandardDirectory>

  <StandardDirectory Id="DesktopFolder" />

  <!-- Файлы приложения (генерируются через Heat) -->
  <Fragment>
    <ComponentGroupRef Id="ApplicationFiles" />
  </Fragment>

  <!-- NSSM файлы -->
  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Directory Id="NSSMFolder" Name="nssm" />
    </DirectoryRef>
    <ComponentGroup Id="NSSMFiles" Directory="NSSMFolder">
      <Component Id="NSSMFilesComponent">
        <File Id="NSSMExe" Source="$(var.NSSMPath)\nssm.exe" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Custom Actions для установки/удаления сервиса через NSSM -->
  <Fragment>
    <CustomAction Id="InstallService"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; install NormTrackerService &quot;[NODEPATH]&quot; &quot;[INSTALLFOLDER]server.js&quot;' />
    
    <CustomAction Id="ConfigureService"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; set NormTrackerService AppDirectory &quot;[INSTALLFOLDER]&quot;' />
    
    <CustomAction Id="ConfigureServiceDisplayName"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; set NormTrackerService DisplayName &quot;NormTracker Service&quot;' />
    
    <CustomAction Id="ConfigureServiceDescription"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; set NormTrackerService Description &quot;Сервис для отслеживания нормативов по физической культуре&quot;' />
    
    <CustomAction Id="ConfigureServiceStart"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; set NormTrackerService Start SERVICE_AUTO_START' />
    
    <CustomAction Id="ConfigureServiceLogs"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; set NormTrackerService AppStdout &quot;[LogsFolder]service.log&quot;' />
    
    <CustomAction Id="ConfigureServiceErrorLogs"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; set NormTrackerService AppStderr &quot;[LogsFolder]service-error.log&quot;' />
    
    <CustomAction Id="StartService"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; start NormTrackerService' />
    
    <CustomAction Id="StopService"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; stop NormTrackerService' />
    
    <CustomAction Id="RemoveService"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  ExeCommand='&quot;[NSSMFolder]nssm.exe&quot; remove NormTrackerService confirm' />
    
    <SetProperty Id="NODEPATH" 
                  Value="$(var.NodePath)" 
                  Sequence="execute" 
                  Before="InstallService" />
    
    <InstallExecuteSequence>
      <Custom Action="InstallService" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="ConfigureService" After="InstallService">NOT Installed</Custom>
      <Custom Action="ConfigureServiceDisplayName" After="ConfigureService">NOT Installed</Custom>
      <Custom Action="ConfigureServiceDescription" After="ConfigureServiceDisplayName">NOT Installed</Custom>
      <Custom Action="ConfigureServiceStart" After="ConfigureServiceDescription">NOT Installed</Custom>
      <Custom Action="ConfigureServiceLogs" After="ConfigureServiceStart">NOT Installed</Custom>
      <Custom Action="ConfigureServiceErrorLogs" After="ConfigureServiceLogs">NOT Installed</Custom>
      <Custom Action="StartService" After="ConfigureServiceErrorLogs">NOT Installed</Custom>
      <Custom Action="StopService" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="RemoveService" After="StopService">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>
  </Fragment>

  <!-- Создание .env файла -->
  <Fragment>
    <Component Id="EnvironmentFile" Directory="INSTALLFOLDER">
      <CreateFolder />
      <File Id="EnvFile" Source="$(var.ProductionPath)\.env.template" />
    </Component>
  </Fragment>

  <!-- Создание папки для логов -->
  <Fragment>
    <DirectoryRef Id="INSTALLFOLDER">
      <Directory Id="LogsFolder" Name="logs" />
    </DirectoryRef>
    <Component Id="LogsDirectory" Directory="LogsFolder">
      <CreateFolder />
      <RemoveFolder Id="RemoveLogsFolder" On="uninstall" />
    </Component>
  </Fragment>

  <!-- Ярлык в меню "Пуск" -->
  <Fragment>
    <Component Id="StartMenuShortcut" Directory="ApplicationProgramsFolder">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="NormTracker"
                Description="Открыть NormTracker в браузере"
                Target="http://localhost:3000"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\NormTracker" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>
  </Fragment>

  <!-- Ярлык на рабочем столе -->
  <Fragment>
    <Component Id="DesktopShortcut" Directory="DesktopFolder">
      <Shortcut Id="ApplicationDesktopShortcut"
                Name="NormTracker"
                Description="Открыть NormTracker в браузере"
                Target="http://localhost:3000"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="RemoveDesktopFolder" Directory="DesktopFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\NormTracker" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>
  </Fragment>

</Wix>

