# Система учёта нормативов по физической культуре

Веб-приложение для учёта сдачи нормативов по физической культуре с разделением ролей администратора и тренера.

## Технологии

- **Next.js 14** (App Router)
- **TypeScript**
- **Tailwind CSS**
- **Prisma ORM**
- **PostgreSQL**
- **JWT** (авторизация через httpOnly cookie)

## Установка

1. Клонируйте репозиторий и установите зависимости:

```bash
npm install
```

2. Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

3. Настройте переменные окружения в `.env`:

```env
DATABASE_URL="postgresql://user:password@localhost:5432/fk_norm?schema=public"
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
NODE_ENV="development"
```

4. Выполните миграции базы данных:

```bash
npm run prisma:migrate
```

5. Создайте первого администратора:

```bash
npm run create-admin [email] [password]
```

Например:
```bash
npm run create-admin admin@example.com admin123
```

Если не указать параметры, будут использованы значения по умолчанию: `admin@example.com` / `admin123`

### Тестовые логины

После создания администратора вы можете войти в систему:

- **Email**: `admin@example.com` (или тот, который вы указали)
- **Пароль**: `admin123` (или тот, который вы указали)

**Примечание**: Для создания тестового тренера войдите как администратор и создайте его через админ-панель (`/admin`).

## Запуск

### Режим разработки

```bash
npm run dev
```

Приложение будет доступно по адресу [http://localhost:3000](http://localhost:3000)

### Production сборка

```bash
npm run build
npm start
```

## Структура проекта

```
├── prisma/
│   └── schema.prisma          # Схема базы данных
├── scripts/
│   └── create-admin.ts        # Скрипт создания администратора
├── src/
│   ├── app/
│   │   ├── api/               # API роуты
│   │   │   ├── auth/          # Авторизация
│   │   │   ├── admin/         # Админ-панель
│   │   │   └── trainer/       # Кабинет тренера
│   │   ├── admin/             # Страница админ-панели
│   │   ├── login/             # Страница входа
│   │   ├── trainer/           # Кабинет тренера
│   │   └── layout.tsx         # Корневой layout
│   ├── components/            # React компоненты
│   │   ├── AdminPanel.tsx
│   │   ├── TrainerCabinet.tsx
│   │   └── Header.tsx
│   └── lib/                   # Утилиты
│       ├── auth.ts            # Функции авторизации
│       └── prisma.ts          # Prisma Client
└── package.json
```

## Роли пользователей

### ADMIN (Администратор)

**Доступ к админ-панели** (`/admin`):
- Управление пользователями: создание, блокировка/разблокировка тренеров
- Сброс паролей тренеров
- Установка срока действия аккаунтов (активен до даты)
- Изменение ролей пользователей (назначение/снятие администратора)
- Управление шаблонами нормативов: создание общих шаблонов, редактирование, активация/деактивация
- Просмотр всех тренеров и пользователей системы

**Дополнительно**: Администратор также имеет доступ ко всем функциям тренера

### TRAINER (Тренер)

**Кабинет тренера** (`/trainer`):
- Редактирование своего профиля (ФИО, телефон, примечания)
- Смена пароля

**Управление группами** (`/trainer/groups`):
- Создание, редактирование и удаление групп
- Фильтрация групп по учебному году
- Просмотр статистики: количество учащихся и уроков в каждой группе

**Управление учениками**:
- Добавление учеников вручную (ФИО, дата рождения, пол, примечания)
- Массовый импорт учеников из Excel-файла (формат: колонка A - ФИО, колонка B - Дата рождения, колонка C - Пол, колонка D - Примечания)
- Редактирование и удаление учеников
- Просмотр детальной информации об ученике

**Управление нормативами**:
- **Групповые нормативы**: добавление нормативов для всей группы одновременно (вручную или из шаблона)
- **Индивидуальные нормативы**: добавление нормативов для конкретных учеников
- Автоматический расчёт оценок на основе шаблонов нормативов (при указании класса группы)
- Редактирование и удаление нормативов
- Просмотр всех нормативов группы в виде таблицы
- Печать отчётов по нормативам

**Журнал группы**:
- Ведение журнала посещаемости и оценок
- Добавление уроков
- Проставление оценок за уроки

**Шаблоны нормативов**:
- Создание личных шаблонов нормативов (доступны только тренеру)
- Использование общих шаблонов, созданных администратором
- Настройка пороговых значений оценок для каждого класса и пола

## API Endpoints

### Авторизация

- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/logout` - Выход из системы
- `POST /api/auth/change-password` - Смена пароля

### Админ-панель

- `GET /api/admin/trainers` - Список тренеров
- `POST /api/admin/trainers` - Создать тренера
- `POST /api/admin/trainers/[id]/toggle-block` - Блокировать/разблокировать
- `POST /api/admin/trainers/[id]/reset-password` - Сбросить пароль

### Кабинет тренера

- `GET /api/trainer/profile` - Получить профиль
- `PUT /api/trainer/profile` - Обновить профиль
- `GET /api/trainer/athletes` - Список спортсменов
- `POST /api/trainer/athletes` - Создать спортсмена
- `GET /api/trainer/athletes/[id]` - Получить спортсмена с нормативами
- `PUT /api/trainer/athletes/[id]` - Обновить спортсмена
- `DELETE /api/trainer/athletes/[id]` - Удалить спортсмена
- `POST /api/trainer/groups/[groupId]/athletes/import` - Импорт спортсменов из Excel-файла
- `GET /api/trainer/groups/[groupId]/athletes/template` - Скачать шаблон Excel-файла
- `POST /api/trainer/norms` - Создать норматив
- `DELETE /api/trainer/norms/[id]` - Удалить норматив

## База данных

Для работы с базой данных используется Prisma:

```bash
# Генерация Prisma Client
npm run prisma:generate

# Создание миграции
npm run prisma:migrate

# Открыть Prisma Studio (GUI для БД)
npm run prisma:studio
```

## Сборка установщика для Windows

Проект включает готовый установщик для Windows, который:
- Устанавливает приложение как Windows-сервис
- Автоматически запускает сервис при загрузке системы
- Предоставляет удобный интерфейс установки и удаления

### Требования для сборки установщика

1. **Inno Setup 6+** - https://innosetup.com/
2. **Node.js 18+**
3. **PowerShell**

### Процесс сборки

1. **Сборка production build:**
   ```powershell
   .\installer\build-production.ps1
   ```

2. **Сборка установщика:**
   ```powershell
   .\installer\build-installer.ps1
   ```

Результат: `dist\NormTracker-Setup-1.0.0.exe`

Подробная документация: [installer/README.md](installer/README.md)

### Установка через установщик

1. Запустите `NormTracker-Setup-1.0.0.exe`
2. Следуйте инструкциям мастера установки
3. Укажите параметры:
   - Порт веб-сервера (по умолчанию 3000)
   - Строка подключения к PostgreSQL (DATABASE_URL)
   - Секретный ключ JWT (JWT_SECRET)
   - Путь к Node.js (node.exe)
4. Установщик автоматически создаст и запустит Windows-сервис

## Деплой

Приложение готово к деплою на стандартные платформы:

- **Vercel** - рекомендуется для Next.js
- **Railway** - поддерживает PostgreSQL
- **Render** - поддерживает PostgreSQL
- **Windows-сервис** - через MSI установщик (см. выше)

При деплое убедитесь, что:
1. Настроена переменная окружения `DATABASE_URL` (внешняя БД)
2. Настроена переменная окружения `JWT_SECRET` (случайная строка)
3. Выполнены миграции базы данных
4. Создан первый администратор

## Безопасность

- Пароли хранятся в виде bcrypt хешей
- JWT токены хранятся в httpOnly cookies
- Проверка ролей на сервере
- Заблокированные пользователи не могут войти в систему

## Импорт учеников из Excel

Приложение поддерживает массовый импорт учеников из Excel-файла.

### Формат файла

Файл должен соответствовать шаблону `4A.xlsx` (находится в корне проекта):

- **Колонка A**: ФИО (обязательно)
- **Колонка B**: Дата рождения (опционально, формат: dd.mm.yyyy или Excel дата)
- **Колонка C**: Пол (опционально, "М" или "Ж")
- **Колонка D**: Примечания (опционально)

### Использование

1. На странице группы перейдите во вкладку "Ученики"
2. Нажмите "Скачать шаблон" для получения файла-шаблона
3. Заполните шаблон данными учеников
4. Нажмите "Добавить учеников из файла" и выберите заполненный файл
5. После успешного импорта список учеников обновится автоматически

### Обработка ошибок

- Если файл не в формате Excel (.xlsx или .xls), будет показана ошибка
- Если формат колонок не соответствует шаблону, некорректные строки будут пропущены
- При наличии ошибок в некоторых строках, они будут пропущены, а валидные строки будут импортированы

## Лицензия

MIT

